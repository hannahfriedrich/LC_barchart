<!DOCTYPE html>
<html>
<head>
    <title>Landcover by Basin Barcharts</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html {
            /*full screen the map*/
            height: 100%;
        }

        body {
            height: 100%;
            padding: 0;
            margin: 0;
        }

        #map {
            width: 50%;
            height: 100%;
        }

        #title {
            position: fixed;
            top: 10px;
            right: 20px;
            padding-top: 10px;
            padding-left: 80px;
        }

        h4 {
            font-family: 'Artifika', serif;

            /*position: absolute;*/
            /*right: 20px;*/
            /*padding-top: 80px;*/
            /*padding-left: 80px;*/
        }

        #lc-chart {
            width: 20%;
            position: fixed;
            right: 20px;
            padding-top: 30px;
            padding-left: 80px;
        }

    </style>

    <!-- Stylesheet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"/>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.css" rel='stylesheet'/>
    <!-- Javascript Libraries -->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    <!-- mapbox gl js -->
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.js"></script>
    <!-- leaflet mapbox js -->
    <script src="https://rawgit.com/mapbox/mapbox-gl-leaflet/master/leaflet-mapbox-gl.js"></script>
    <!--D3 and DC libraries-->
    <link rel="stylesheet" type="text/css" href="http://dc-js.github.io/dc.js/css/dc.css" />
    <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
    <script type="text/javascript" src="https://dc-js.github.io/dc.js/js/dc.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Artifika" rel="stylesheet">


</head>

<body>
<div id="map"></div>
<div id="title">
    <h4>Distribution of Landcover by Basin</h4>
    <div id="lc-chart"></div>
</div>


<script>


    // Set style function that sets fill color property equal to cell tower density
    function style(feature) {
        return {
            fillColor: '#008080',
            fillOpacity: 0.7,
            weight: 1,
            opacity: 1,
            color: '#ffffff',
        };
    }

    // Interactive features
    // Highlight a feature when the mouse hovers on it
    function highlightFeature(e) {
        // e indicates the current event
        var layer = e.target; //the target capture the object which the event associates with
        layer.setStyle({
            weight: 5,
            opacity: 0.6,
            color: '#e1e0e3',
            fillColor: '#9a7ee3',
            fillOpacity: 0.5
        });
        // bring the layer to the front.
        layer.bringToFront();
    }

    // Zoom to the highlighted feature when the mouse is clicking onto it.
    function zoomToFeature(e) {
        map.fitBounds(e.target.getBounds());
    }

    // Reset the hightlighted feature when the mouse is out of its region.
    function resetHighlight(e) {
        basins.resetStyle(e.target);
    }




    var map = L.map('map').setView([13.29119, -22.92940], 4);

    mapbox_token = 'pk.eyJ1IjoiZnJpZWRyaWgiLCJhIjoiY2o4eGYyZzllMGtiYjMzcGp0cTM5NXZ0cCJ9.BPCA9enT7iq6naVIOEHK9w';
//
//    var gl = L.mapboxGL({
//        accessToken: mapbox_token,
//        style: 'assets/style.json',
//        attribution: 'Created By <a href="https://github.com/hannahfriedrich/">Hannah Friedrich</a> based on the <a href="assets/license.txt">Mapbox basic style</a>'
//    }).addTo(map);


    var lcTile =L.tileLayer('assets/qtiles/MODIS_vis3/{z}/{x}/{y}.png', {
        maxZoom: 6,
        tms: false,
        attribution: 'Generated by QTiles'
    }).addTo(map);

    var basins = null;
    // Add Neighborhood Polygons
    basins = L.geoJson.ajax("assets/basins_simplified.geojson", {
        //style: style
        style: style,
        onEachFeature: function (feature, label) {
            label.on({
                mouseover: highlightFeature,
                click: zoomToFeature,
                mouseout: resetHighlight
            });

//            label.bindTooltip(feature.properties.name, {className: 'feature-label', permanent:true, direction: 'center'});
//            labels.push(label);
//
//
//        },
        }}).addTo(map);

    updateMapFilter();

///////////////CHART CREATION//////////////////////////
    function updateMapFilter() {


        // map.flyTo(map.getCenter(),map.getZoom());
        var data = null;

        url = lcTile._ctx.canvas._image.src;
        //console.log(src);
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'arraybuffer';
        xhr.onload = function(e) {
            tt = this.response;
            var img = UPNG.decode(tt);
            var rgba = UPNG.toRGBA8(img)[0];
            var h = img.height;
            var w = img.width;
            var ctype = img.ctype;
            var depth = img.depth;
            data = img.data;

            console.log("depth:" + depth.toString());
            console.log("ctype:" + ctype.toString());
            console.log("mean:" + ss.mean(data).toString());
            console.log("median:" + ss.median(data).toString());
            console.log("max:" + ss.max(data).toString());
            console.log(data);

    var dataarray = Array.from(lcTile);
    var newarray = [];
    for(var i=0;i<dataarray.length;i++) {

        if (dataarray[i] < 251 && dataarray[i] > 0) {
            newarray.push(dataarray[i]);
        }
    }
    dataarray = newarray;
    newarray = null;

    //var dataarray = uint8ArrayToArray(data);
    //create crossfilter and filter all the data.
    var filter = crossfilter(dataarray); //Create a crossfilter, input all the geospatial data.


    //create charts
    var lcChart = dc.barChart('#lc-chart');

    var lcDimension = filter.dimension(function(d) {
        var veg = d;
        return  veg  = 0 ? 'Water':
            veg = 1  ? 'Forest' :
                veg = 2 ? 'Forest2' :
                    veg = 3 ? 'Forest3' :
                        veg = 4 ? 'Forest4' :
                            veg = 5 ? 'Forest5' :
                                veg = 6 ? 'Shrubland' :
                                    veg = 7 ? 'Shrubland2' :
                                        veg = 8 ? 'Savannas/Grasslands' :
                                            veg = 9 ? 'Savannas/Grasslands2':
                                                veg = 10 ? 'Savannas/Grasslands3' :
                                                    veg = 11 ? 'Wetlands' :
                                                        veg = 12 ? 'Croplands' :
                                                            veg = 13 ? 'Urban' :
                                                                veg = 14 ? 'Cropland/natural veg' :
                                                                    veg = 15 ? 'Snow/ice' :
                                                                        veg = 16 ? 'Barren' : ''




    });


    var lcDimensionGroup = lcDimension.group();


    lcChart
        .height(400)
        .width(600)
        .margins({top:0, right: 50, bottom: 50, left: 45})
        .dimension(lcDimension)
        .group(lcDimensionGroup)
        .elasticY(true)
        .elasticX(false)
        .x(d3.scaleOrdinal())
        //.x(d3.scale.ordinalColors(['#dfc27d','#cdbd7c','#bab87b','#a7b37a','#95ae79','#82a978','#70a477', '#5e9e76', '#4b9975', '#389474', '#268f73']))
        .xUnits(dc.units.ordinal)
        .yAxis()
        //                .xAxisLabel('NDVI Value')
        //                .yAxisLabel('Count')
        //                .renderLabel(true)
        //                .label(function (p) {
        //                    return p.key;
        //                })
        .ticks(5);


    dc.renderAll();

    var bars = $("rect.bar");
    for(var i =0; i< bars.length;i++) {
        text_tmp = $(bars[i]).find("title").text();
        text = (text_tmp.split(":")[0]);
        if (text == "Water") {
            $(bars[i]).css({ fill: '#abb6ff' });
        }
        if (text == "Forest" || text == "Forest2" || text == "Forest3" || text == "Forest4" || text == "Forest5" ) {
            $(bars[i]).css({ fill: '#53a37a' });
        }
        if (text == "Shrubland" || text == "Shrubland2") {
            $(bars[i]).css({ fill: '#eeddb9' });
        }
        if (text == "Savannas/Grasslands" || text == "Savannas/Grasslands2" || text == "Savannas/Grasslands3") {
            $(bars[i]).css({ fill: '#faf6a7' });
        }
        if (text == "Wetlands") {
            $(bars[i]).css({ fill: '#a1c8c1' });
        }
        if (text == "Croplands") {
            $(bars[i]).css({ fill: '#e4e5a6' });
        }
        if (text == "Urban") {
            $(bars[i]).css({ fill: '#ac9ab0' });
        }
        if (text == "Cropland/natural veg") {
            $(bars[i]).css({ fill: '#76a53d' });
        }
        if (text == "Snow/ice") {
            $(bars[i]).css({ fill: '#efefee' });
        }
        if (text == "Barren") {
            $(bars[i]).css({ fill: '#d2c4b4' });
        }


    };

    };




       //dc.redrawAll();

    }


</script>
</body>
</html>