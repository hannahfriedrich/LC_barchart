<!DOCTYPE html>
<html>
<head>
    <title>Landcover by Basin Barcharts</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html {
            /*full screen the map*/
            height: 100%;
        }

        body {
            height: 100%;
            padding: 0;
            margin: 0;
        }

        #map {
            width: 50%;
            height: 100%;
        }

        #title {
            position: absolute;
            right: 20px;
            padding-top: 80px;
            padding-left: 80px;
        }

        h4 {
            font-family: 'Artifika', serif;

            /*position: absolute;*/
            /*right: 20px;*/
            /*padding-top: 80px;*/
            /*padding-left: 80px;*/
        }

        #mag-chart {
            width: 20%;
            position: absolute;
            right: 20px;
            padding-top: 80px;
            padding-left: 80px;
        }

    </style>

    <!-- Stylesheet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"/>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.css" rel='stylesheet'/>
    <!-- Javascript Libraries -->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    <!-- mapbox gl js -->
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.js"></script>
    <!-- leaflet mapbox js -->
    <script src="https://rawgit.com/mapbox/mapbox-gl-leaflet/master/leaflet-mapbox-gl.js"></script>
    <!--D3 and DC libraries-->
    <link rel="stylesheet" type="text/css" href="http://dc-js.github.io/dc.js/css/dc.css" />
    <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
    <script type="text/javascript" src="https://dc-js.github.io/dc.js/js/dc.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Artifika" rel="stylesheet">


</head>

<body>
<div id="map"></div>
<div id="title">
    <h4>Distribution of Landcover by Basin</h4>
    <div id="lc-chart"></div>
</div>


<script>


    // Set style function that sets fill color property equal to cell tower density
    function style(feature) {
        return {
            fillColor: '#008080',
            fillOpacity: 0.7,
            weight: 1,
            opacity: 1,
            color: '#ffffff',
        };
    }

    // Interactive features
    // Highlight a feature when the mouse hovers on it
    function highlightFeature(e) {
        // e indicates the current event
        var layer = e.target; //the target capture the object which the event associates with
        layer.setStyle({
            weight: 5,
            opacity: 0.6,
            color: '#e1e0e3',
            fillColor: '#9a7ee3',
            fillOpacity: 0.5
        });
        // bring the layer to the front.
        layer.bringToFront();
    }

    // Zoom to the highlighted feature when the mouse is clicking onto it.
    function zoomToFeature(e) {
        map.fitBounds(e.target.getBounds());
    }

    // Reset the hightlighted feature when the mouse is out of its region.
    function resetHighlight(e) {
        basins.resetStyle(e.target);
    }

    var map = L.map('map').setView([13.29119, -22.92940], 4);

    mapbox_token = 'pk.eyJ1IjoiZnJpZWRyaWgiLCJhIjoiY2o4eGYyZzllMGtiYjMzcGp0cTM5NXZ0cCJ9.BPCA9enT7iq6naVIOEHK9w';
//
//    var gl = L.mapboxGL({
//        accessToken: mapbox_token,
//        style: 'assets/style.json',
//        attribution: 'Created By <a href="https://github.com/hannahfriedrich/">Hannah Friedrich</a> based on the <a href="assets/license.txt">Mapbox basic style</a>'
//    }).addTo(map);


    var lcTile =L.tileLayer('assets/qtiles/MODIS_vis3/{z}/{x}/{y}.png', {
        maxZoom: 6,
        tms: false,
        attribution: 'Generated by QTiles'
    }).addTo(map);

    var basins = null;
    // Add Neighborhood Polygons
    basins = L.geoJson.ajax("assets/basins_simplified.geojson", {
        //style: style
        style: style,
        onEachFeature: function (feature, label) {
            label.on({
                mouseover: highlightFeature,
                click: zoomToFeature,
                mouseout: resetHighlight
            });

//            label.bindTooltip(feature.properties.name, {className: 'feature-label', permanent:true, direction: 'center'});
//            labels.push(label);
//
//
//        },
        }}).addTo(map);


///////////////CHART CREATION//////////////////////////
    var dataarray = Array.from(lcTile);
    var newarray = [];
    for(var i=0;i<dataarray.length;i++) {

        if (dataarray[i] < 251 && dataarray[i] > 0) {
            newarray.push(dataarray[i]);
        }
    }
    dataarray = newarray;
    newarray = null;

    //var dataarray = uint8ArrayToArray(data);
    //create crossfilter and filter all the data.
    var filter = crossfilter(dataarray); //Create a crossfilter, input all the geospatial data.


    //create charts
    var lcChart = dc.barChart('#lc-chart');

    var vegDimension = filter.dimension(function(d) {
        var veg = d;
        return  veg  < 25 ? '0-0.2':
            veg < 50 ? '0.21-0.25' :
                veg < 75 ? '0.26-0.30' :
                    veg < 100 ? '0.31-0.35' :
                        veg < 125 ? '0.36-0.40' :
                            veg < 150 ? '0.41-0.45' :
                                veg < 175 ? '0.46-0.50' :
                                    veg < 200 ? '0.51-0.55' :
                                        veg < 225 ? '0.56-0.60' :
                                            veg < 251 ? '0.61-0.65':'>0.65'


    });


    var lcDimensionGroup = lcDimension.group();


    lcChart
        .height(400)
        .width(600)
        .margins({top:0, right: 50, bottom: 50, left: 45})
        .dimension(lcDimension)
        .group(lcDimensionGroup)
        .elasticY(true)
        .elasticX(false)
        .x(d3.scale.ordinal())
        //.x(d3.scale.ordinalColors(['#dfc27d','#cdbd7c','#bab87b','#a7b37a','#95ae79','#82a978','#70a477', '#5e9e76', '#4b9975', '#389474', '#268f73']))
        .xUnits(dc.units.ordinal)
        .yAxis()
        //                .xAxisLabel('NDVI Value')
        //                .yAxisLabel('Count')
        //                .renderLabel(true)
        //                .label(function (p) {
        //                    return p.key;
        //                })
        .ticks(5)
    ;


    dc.renderAll();

//    var bars = $("rect.bar");
//    for(var i =0; i< bars.length;i++) {
//        text_tmp = $(bars[i]).find("title").text();
//        text = (text_tmp.split(":")[0]);
//        if (text == "0-0.2") {
//            $(bars[i]).css({ fill: '#dfc27d' });
//        }
//        if (text == "0.21-0.25") {
//            $(bars[i]).css({ fill: '#cdbd7c' });
//        }
//        if (text == "0.26-0.30") {
//            $(bars[i]).css({ fill: '#bab87b' });
//        }
//        if (text == "0.31-0.35") {
//            $(bars[i]).css({ fill: '#a7b37a' });
//        }
//        if (text == "0.36-0.40") {
//            $(bars[i]).css({ fill: '#95ae79' });
//        }
//        if (text == "0.41-0.45") {
//            $(bars[i]).css({ fill: '#82a978' });
//        }
//        if (text == "0.46-0.50") {
//            $(bars[i]).css({ fill: '#70a477' });
//        }
//        if (text == "0.51-0.55") {
//            $(bars[i]).css({ fill: '#5e9e76' });
//        }
//        if (text == "0.56-0.60") {
//            $(bars[i]).css({ fill: '#4b9975' });
//        }
//        if (text == "0.61-0.65") {
//            $(bars[i]).css({ fill: '#389474' });
//        }
//        if (text == ">0.65") {
//            $(bars[i]).css({ fill: '#268f73' });
//        }
//
//
//    };
//
//    //};
//
//
//
//
//    //   dc.redrawAll();
//
//    }


</script>
</body>
</html>